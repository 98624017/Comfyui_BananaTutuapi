---
name: image-generation-enhancement
description: 新增 APICore.ai 提供商支持、修复 num_images 功能并优化代码质量
status: backlog
created: 2025-09-17T15:56:06Z
---

# PRD: Image Generation Enhancement

## Executive Summary

本 PRD 旨在提升 ComfyUI BananaTutu API 插件的功能性和稳定性，通过新增 APICore.ai 作为第三个 API 提供商、修复现有的 num_images 批量生成功能缺陷，以及清理优化代码结构，为用户提供更可靠和多样化的图像生成体验。

## Problem Statement

### 当前存在的问题：

1. **API 提供商局限性**：目前仅支持 ai.comfly.chat 和 OpenRouter 两个提供商，用户选择有限
2. **num_images 功能失效**：虽然界面提供 1-4 张图片的选择，但实际无法按设定数量生成图片
3. **代码冗余问题**：存在大量废弃和无效代码，影响维护性和性能

### 为什么现在解决这个问题很重要：

- **用户体验**：num_images 功能失效直接影响用户工作流程效率
- **竞争优势**：更多 API 提供商选择能提高服务可用性和成本优化
- **代码质量**：清理废弃代码有助于后续功能开发和维护

## User Stories

### 主要用户画像：
- **数字艺术家**：需要批量生成多个版本的创意图像
- **内容创作者**：需要稳定可靠的图像生成服务
- **开发者/研究员**：需要测试不同 API 提供商的效果

### 详细用户旅程：

#### 用户故事 1：多提供商选择
**作为** 一名数字艺术家
**我希望** 能够选择使用 APICore.ai 作为图像生成提供商
**以便** 在其他服务不可用时有备选方案，并能比较不同提供商的生成效果

**验收标准：**
- [ ] 在 API 提供商下拉菜单中能看到 "APICore.ai" 选项
- [ ] 选择 APICore.ai 后能正常生成图像
- [ ] 支持 APICore.ai 的多图片参考功能
- [ ] API 密钥配置界面包含 APICore.ai 的配置项

#### 用户故事 2：批量图像生成
**作为** 一名内容创作者
**我希望** num_images 参数能按设定数量生成对应数量的图片
**以便** 一次性获得多个变体选择，提高创作效率

**验收标准：**
- [ ] 设置 num_images=3 时，实际输出 3 张不同的图片
- [ ] 每张图片都是独特的变体，不是重复内容
- [ ] 支持 1-4 张图片的批量生成
- [ ] 生成时间合理，不会因数量增加而导致超时

#### 用户故事 3：代码维护性
**作为** 一名插件维护者
**我希望** 代码结构清晰，没有废弃的无效代码
**以便** 更容易添加新功能和修复问题

**验收标准：**
- [ ] 移除所有未使用的导入和函数
- [ ] 清理注释掉的废弃代码块
- [ ] 统一代码风格和命名约定
- [ ] 简化复杂的逻辑分支

## Requirements

### Functional Requirements

#### 1. APICore.ai 集成
- **API 端点集成**：添加 `https://ismaque.org/v1/images/generations` 端点支持
- **认证方式**：支持 Bearer token 认证方式
- **模型支持**：
  - `gemini-2.5-flash-image`（标准版本）
  - `gemini-2.5-flash-image-hd`（4K 高清版本）
- **多图片参考**：支持用户提供的多图片 URL 格式：`"https://img1.jpg https://img2.jpg https://img3.jpg 描述文本"`
- **配置管理**：在 `Tutuapi.json` 中添加 `apicore_api_key` 字段

#### 2. num_images 功能修复
- **请求参数修正**：确保 API 请求中的 `"n"` 参数正确传递用户设置的 num_images 值
- **响应处理优化**：正确解析包含多张图片的 API 响应
- **输出格式统一**：确保返回的图片列表格式符合 ComfyUI 标准
- **错误处理**：当 API 返回的图片数量与请求不符时，提供清晰的错误信息

#### 3. 代码清理优化
- **移除废弃代码**：清理未使用的导入、函数和注释代码块
- **简化 SSE 解析**：优化复杂的流式响应解析逻辑
- **统一错误处理**：建立统一的错误处理机制
- **性能优化**：减少不必要的图像转换和网络请求

### Non-Functional Requirements

#### 性能要求
- **响应时间**：单张图片生成不超过 30 秒，多张图片按比例增加
- **内存使用**：避免内存泄漏，及时释放图像资源
- **并发支持**：支持多个用户同时使用不同 API 提供商

#### 安全要求
- **API 密钥保护**：确保 API 密钥不会在日志中泄露
- **输入验证**：验证图片 URL 的有效性和安全性
- **错误信息脱敏**：避免在错误信息中暴露敏感的 API 细节

#### 兼容性要求
- **向后兼容**：确保现有工作流程不受影响
- **ComfyUI 兼容**：遵循 ComfyUI 节点开发规范
- **Python 版本**：支持 Python 3.8+ 版本

## Success Criteria

### 可测量结果
1. **功能完整性**：100% 通过功能测试用例
2. **性能指标**：
   - 单图生成成功率 ≥ 95%
   - 多图生成数量准确率 = 100%
   - 平均响应时间减少 ≥ 20%
3. **代码质量**：
   - 代码行数减少 ≥ 15%
   - 代码复杂度降低（圈复杂度 < 10）
   - 无静态分析警告

### 关键指标和 KPI
- **用户满意度**：新增 APICore.ai 选项的使用率
- **功能可靠性**：num_images 功能的错误率 < 1%
- **维护效率**：代码变更导致的回归错误率 < 2%

## Constraints & Assumptions

### 技术限制
- **API 配额限制**：各 API 提供商都有使用配额限制
- **网络依赖**：需要稳定的网络连接访问外部 API
- **图片格式**：受限于各 API 提供商支持的图片格式

### 时间约束
- **开发周期**：预计 1-2 周完成所有功能
- **测试周期**：至少 3 天进行全面测试
- **部署周期**：1 天进行部署和验证

### 资源限制
- **测试环境**：需要有效的 API 密钥进行测试
- **开发人力**：单人开发项目
- **设备要求**：需要支持 ComfyUI 的开发环境

### 关键假设
- **API 稳定性**：假设 APICore.ai 的 API 服务稳定可用
- **文档准确性**：假设提供的 API 文档信息准确无误
- **用户环境**：假设用户具备基本的 ComfyUI 使用经验

## Out of Scope

### 明确不包含的功能
- **新增其他 API 提供商**：除 APICore.ai 外的其他提供商
- **UI 界面重设计**：保持现有界面布局和风格
- **图片后处理功能**：不增加图片编辑或滤镜功能
- **本地模型支持**：不添加本地 AI 模型支持
- **用户管理系统**：不涉及用户账户或权限管理
- **图片存储服务**：不实现永久图片存储功能

### 后续版本考虑
- **更多图片尺寸选项**：支持自定义图片尺寸
- **批量提示词处理**：支持 CSV 文件批量处理
- **图片风格迁移**：添加风格迁移功能

## Dependencies

### 外部依赖
- **APICore.ai 服务**：新的 API 提供商服务可用性
- **网络连接**：稳定的互联网连接
- **ComfyUI 框架**：兼容的 ComfyUI 版本

### 内部团队依赖
- **测试 API 密钥**：需要有效的 APICore.ai 测试密钥
- **开发环境**：配置好的 ComfyUI 开发环境
- **Python 虚拟环境**：F:\ComfyUI-aki-v1.3\env\python.exe

### 技术栈依赖
- **Python 库**：requests, base64, json, PIL/Pillow
- **ComfyUI API**：tensor2pil, pil2tensor 转换函数
- **HTTP 客户端**：用于 API 调用的网络库

## Implementation Notes

### 关键技术要点
1. **APICore.ai 集成**：
   - 基础 URL：`https://ismaque.org/v1/images/generations`
   - 认证头：`Authorization: Bearer {api_key}`
   - 请求格式：标准 JSON POST 请求

2. **num_images 修复要点**：
   - 检查当前 `"n"` 参数的传递链路
   - 验证 API 响应解析逻辑
   - 确保批量图片的正确输出格式

3. **代码优化重点**：
   - 移除 460-800 行的复杂 SSE 解析逻辑（如果 APICore.ai 不需要）
   - 简化图片上传和下载流程
   - 统一错误处理和日志记录

### 测试策略
- **单元测试**：各 API 提供商的独立测试
- **集成测试**：完整的图片生成流程测试
- **压力测试**：多图片并发生成测试
- **兼容性测试**：确保不影响现有功能

### 风险缓解
- **API 变更风险**：保留原有提供商作为备选
- **功能回归风险**：全面的回归测试覆盖
- **性能降低风险**：性能基准测试和监控
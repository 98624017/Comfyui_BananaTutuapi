---
name: image-generation-enhancement
status: in-progress
created: 2025-09-17T16:10:45Z
progress: 14%
updated: 2025-09-18T01:59:26Z
prd: .claude/prds/image-generation-enhancement.md
github: https://github.com/98624017/Comfyui_BananaTutuapi/issues/1
---

# Epic: Image Generation Enhancement

## Overview

本 Epic 旨在通过三个核心改进提升 ComfyUI BananaTutu API 插件的功能性和稳定性：新增 APICore.ai 作为第三个 API 提供商、修复 num_images 批量生成功能，以及优化代码结构。采用渐进式实现策略，优先修复核心功能问题，再扩展新功能。

## Architecture Decisions

### API 集成架构
- **统一API接口模式**：扩展现有的 API 提供商模式，保持与 ai.comfly.chat 和 OpenRouter 一致的接口设计
- **配置管理策略**：利用现有的 `Tutuapi.json` 配置文件，添加 APICore.ai 密钥管理
- **错误处理统一**：建立统一的 API 错误处理机制，提供一致的用户反馈

### 数据流优化
- **请求参数标准化**：确保 `num_images` 参数正确映射到各提供商的 `"n"` 参数
- **响应解析简化**：移除复杂的 SSE 流解析（如果 APICore.ai 使用标准 JSON 响应）
- **图像处理管道**：保持现有的 tensor2pil/pil2tensor 转换机制

### 代码结构决策
- **最小化变更原则**：在现有 `Tutu.py` 中扩展功能，避免大规模重构
- **向后兼容保证**：确保现有工作流程和 API 调用方式不受影响
- **模块化设计**：将 APICore.ai 相关逻辑封装为独立函数

## Technical Approach

### Backend Services
#### API 端点扩展
- **新增 APICore.ai 端点**：`https://ismaque.org/v1/images/generations`
- **认证机制**：实现 Bearer token 认证方式
- **模型支持**：
  - `gemini-2.5-flash-image`（标准版本）
  - `gemini-2.5-flash-image-hd`（4K 高清版本）

#### 请求处理优化
- **num_images 参数修复**：确保请求体中 `"n"` 参数正确传递
- **多图片参考支持**：解析用户提供的多图片 URL 格式
- **响应处理统一**：标准化各提供商的图片响应格式

#### 数据模型更新
- **配置模型扩展**：在 `Tutuapi.json` 中添加 `apicore_api_key` 字段
- **提供商枚举**：更新 API 提供商选择列表
- **模型映射**：建立 APICore.ai 模型名称映射关系

### Frontend Components
#### UI 组件更新
- **提供商选择**：在下拉菜单中添加 "APICore.ai" 选项
- **模型选择**：根据选择的提供商动态更新可用模型列表
- **错误显示**：改进错误信息展示，提供更清晰的反馈

#### 状态管理
- **配置验证**：验证 API 密钥的有效性
- **批量生成状态**：正确处理多图片生成的进度状态
- **错误恢复**：提供用户友好的错误恢复机制

### Infrastructure
#### 部署考虑
- **配置文件安全**：确保测试密钥不会提交到远程仓库
- **依赖管理**：确认所有必需的 Python 库依赖
- **版本兼容性**：验证与现有 ComfyUI 版本的兼容性

#### 性能监控
- **响应时间监控**：跟踪各 API 提供商的响应性能
- **内存使用优化**：及时释放图像资源，避免内存泄漏
- **错误率统计**：监控 API 调用失败率和原因

## Implementation Strategy

### 开发阶段规划
1. **第一阶段（核心修复）**：修复 num_images 功能，确保现有功能稳定
2. **第二阶段（功能扩展）**：集成 APICore.ai，新增 API 提供商选择
3. **第三阶段（质量提升）**：代码清理优化，移除废弃代码

### 风险缓解策略
- **功能回归风险**：每个阶段完成后进行全面回归测试
- **API 变更风险**：保留原有提供商作为备选方案
- **性能降低风险**：建立性能基准测试和持续监控

### 测试方法
- **单元测试**：各 API 提供商的独立功能测试
- **集成测试**：完整的图片生成流程验证
- **压力测试**：多图片并发生成场景测试
- **兼容性测试**：确保不影响现有工作流程

## Task Breakdown Preview

高级任务分类（预计 7 个核心任务）：

- [ ] **T1: num_images 功能修复** - 修复批量图片生成的核心问题
- [ ] **T2: APICore.ai 基础集成** - 添加新的 API 提供商支持
- [ ] **T3: 多图片参考功能** - 实现 APICore.ai 的多图片输入支持
- [ ] **T4: 配置管理优化** - 更新密钥配置和验证机制
- [ ] **T5: 错误处理统一** - 建立统一的错误处理和用户反馈
- [ ] **T6: 代码清理重构** - 移除废弃代码，优化性能
- [ ] **T7: 集成测试验证** - 全面测试所有功能和兼容性

## Dependencies

### 外部服务依赖
- **APICore.ai 服务可用性**：新 API 提供商的稳定性
- **网络连接质量**：稳定的互联网连接访问各 API 端点
- **测试 API 密钥**：有效的 APICore.ai 测试密钥（sk-OW9u986Ml6NzwqL3StL9o8w0IJP8rHgj3D70wz4jcqMBw0GQ）

### 内部技术依赖
- **ComfyUI 框架**：兼容的 ComfyUI 版本和 API
- **Python 环境**：F:\ComfyUI-aki-v1.3\env\python.exe
- **现有代码库**：当前的 Tutu.py、utils.py 等核心文件

### 开发工具依赖
- **Python 库**：requests, base64, json, PIL/Pillow
- **测试工具**：用于 API 调用测试的工具和脚本
- **代码分析工具**：静态代码分析和性能监控工具

## Success Criteria (Technical)

### 性能基准
- **响应时间**：单张图片生成 ≤ 30 秒，多张图片按比例增加
- **成功率**：单图生成成功率 ≥ 95%，多图生成数量准确率 = 100%
- **性能提升**：平均响应时间减少 ≥ 20%

### 质量指标
- **功能完整性**：100% 通过功能测试用例
- **代码质量**：代码行数减少 ≥ 15%，圈复杂度 < 10
- **错误处理**：无静态分析警告，API 错误率 < 1%

### 验收标准
- **UI 功能**：API 提供商选择包含 APICore.ai 选项
- **核心功能**：num_images 参数按设定数量正确生成图片
- **多图参考**：支持多图片 URL 输入格式
- **向后兼容**：现有工作流程不受影响

## Estimated Effort

### 总体时间预估
- **开发时间**：5-7 个工作日
- **测试时间**：2-3 个工作日
- **部署验证**：1 个工作日
- **总计**：1-2 周完成

### 资源需求
- **开发人力**：1 名开发者（单人项目）
- **测试环境**：配置好的 ComfyUI 开发环境
- **API 资源**：各提供商的测试配额

### 关键路径
1. **num_images 修复**（2 天）- 最高优先级，影响现有功能
2. **APICore.ai 集成**（2-3 天）- 核心新功能开发
3. **代码优化清理**（1-2 天）- 质量提升和性能优化
4. **集成测试**（2 天）- 确保所有功能正常工作

### 风险缓冲
- **技术复杂度**：预留 20% 的时间缓冲处理意外技术问题
- **API 调试**：预留额外时间用于 API 集成调试和优化
- **回归测试**：确保有足够时间进行全面的兼容性验证